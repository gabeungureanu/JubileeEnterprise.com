<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jubilee Browser Automated Test Suite</title>
  <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem;
    }
    h1 {
      color: #1e3a5f;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #666;
      margin-bottom: 1rem;
    }
    .run-controls {
      background: linear-gradient(135deg, #1e3a5f, #2d5a87);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      color: white;
      text-align: center;
    }
    .run-controls h2 {
      margin-bottom: 1rem;
    }
    .btn {
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.2s;
      margin: 0.25rem;
    }
    .btn-large {
      padding: 1rem 3rem;
      font-size: 1.25rem;
    }
    .btn-run {
      background: #4ade80;
      color: #1e3a5f;
    }
    .btn-run:hover {
      background: #22c55e;
      transform: scale(1.02);
    }
    .btn-run:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    .btn-reset {
      background: #f87171;
      color: white;
    }
    .btn-reset:hover {
      background: #ef4444;
    }
    .btn-outline {
      background: transparent;
      border: 2px solid white;
      color: white;
    }
    .btn-outline:hover {
      background: rgba(255,255,255,0.1);
    }
    .progress-section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .progress-bar-container {
      background: #e5e5e5;
      border-radius: 8px;
      height: 30px;
      overflow: hidden;
      margin: 1rem 0;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4ade80, #22c55e);
      border-radius: 8px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }
    .progress-bar.running {
      background: linear-gradient(90deg, #d4a843, #e6b84d);
    }
    .progress-bar.failed {
      background: linear-gradient(90deg, #f87171, #ef4444);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }
    .stat-box {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background: #f8f8f8;
    }
    .stat-box.passed { background: #dcfce7; }
    .stat-box.failed { background: #fee2e2; }
    .stat-box.pending { background: #fef3c7; }
    .stat-box.running { background: #e0f2fe; }
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
    }
    .stat-label {
      font-size: 0.875rem;
      color: #666;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h3 {
      color: #1e3a5f;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .test-section h3 .icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .test-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      background: #f8f8f8;
      transition: all 0.3s;
    }
    .test-item.running {
      background: #e0f2fe;
      border-left: 4px solid #0ea5e9;
    }
    .test-item.passed {
      background: #dcfce7;
      border-left: 4px solid #4ade80;
    }
    .test-item.failed {
      background: #fee2e2;
      border-left: 4px solid #f87171;
    }
    .test-item.skipped {
      background: #fef3c7;
      border-left: 4px solid #d4a843;
    }
    .test-status-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .test-status-icon.pending { background: #e5e5e5; color: #666; }
    .test-status-icon.running { background: #0ea5e9; color: white; }
    .test-status-icon.passed { background: #4ade80; color: white; }
    .test-status-icon.failed { background: #f87171; color: white; }
    .test-status-icon.skipped { background: #d4a843; color: white; }
    .test-name {
      flex: 1;
      font-weight: 500;
    }
    .test-message {
      font-size: 0.875rem;
      color: #666;
    }
    .test-time {
      font-size: 0.75rem;
      color: #999;
    }
    .log-section {
      background: #1e293b;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-section h3 {
      color: #94a3b8;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      text-transform: uppercase;
    }
    .log-entry {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.8rem;
      padding: 0.25rem 0;
      border-bottom: 1px solid #334155;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-entry.info { color: #94a3b8; }
    .log-entry.success { color: #4ade80; }
    .log-entry.error { color: #f87171; }
    .log-entry.warn { color: #fbbf24; }
    .log-time {
      color: #64748b;
      margin-right: 0.5rem;
    }
    .results-section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .results-section h3 {
      color: #1e3a5f;
      margin-bottom: 1rem;
    }
    .results-summary {
      font-size: 1.25rem;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 1rem;
    }
    .results-summary.success {
      background: #dcfce7;
      color: #166534;
    }
    .results-summary.partial {
      background: #fef3c7;
      color: #92400e;
    }
    .results-summary.failure {
      background: #fee2e2;
      color: #991b1b;
    }
    pre.results-text {
      background: #f8f8f8;
      padding: 1rem;
      border-radius: 4px;
      font-size: 0.8rem;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #e5e5e5;
      border-top-color: #0ea5e9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .hidden { display: none !important; }
    footer {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #ddd;
      color: #666;
    }
    .environment-info {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.875rem;
    }
    .environment-info h4 {
      color: #0369a1;
      margin-bottom: 0.5rem;
    }
    .env-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
    }
    .env-item {
      display: flex;
      gap: 0.5rem;
    }
    .env-label { color: #666; }
    .env-value { font-weight: 600; color: #1e3a5f; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Jubilee Browser Automated Test Suite</h1>
    <p class="subtitle">Automated verification tests for Jubilee Browser v8.0.7 (.NET 8 WPF)</p>

    <!-- Environment Info -->
    <div class="environment-info" id="envInfo">
      <h4>Environment</h4>
      <div class="env-grid">
        <div class="env-item"><span class="env-label">Browser:</span> <span class="env-value" id="envBrowser">Detecting...</span></div>
        <div class="env-item"><span class="env-label">Version:</span> <span class="env-value" id="envVersion">--</span></div>
        <div class="env-item"><span class="env-label">Mode:</span> <span class="env-value" id="envMode">--</span></div>
        <div class="env-item"><span class="env-label">InspireCodex API:</span> <span class="env-value" id="envApi">--</span></div>
      </div>
    </div>

    <!-- Run Controls -->
    <div class="run-controls">
      <h2>Test Runner</h2>
      <button class="btn btn-run btn-large" id="runAllBtn" onclick="runAllTests()">
        Run All Tests
      </button>
      <button class="btn btn-outline" id="resetBtn" onclick="resetTests()">
        Reset
      </button>
    </div>

    <!-- Progress Section -->
    <div class="progress-section">
      <h3 id="progressTitle">Ready to run tests</h3>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
      </div>
      <div class="stats">
        <div class="stat-box passed">
          <div class="stat-number" id="passedCount">0</div>
          <div class="stat-label">Passed</div>
        </div>
        <div class="stat-box failed">
          <div class="stat-number" id="failedCount">0</div>
          <div class="stat-label">Failed</div>
        </div>
        <div class="stat-box pending">
          <div class="stat-number" id="skippedCount">0</div>
          <div class="stat-label">Skipped</div>
        </div>
        <div class="stat-box running">
          <div class="stat-number" id="totalTime">0ms</div>
          <div class="stat-label">Total Time</div>
        </div>
      </div>
    </div>

    <!-- Test Sections -->
    <div id="testSections"></div>

    <!-- Log Section -->
    <div class="log-section">
      <h3>Test Log</h3>
      <div id="logEntries"></div>
    </div>

    <!-- Results Section (hidden until tests complete) -->
    <div class="results-section hidden" id="resultsSection">
      <h3>Test Results</h3>
      <div class="results-summary" id="resultsSummary"></div>
      <pre class="results-text" id="resultsText"></pre>
      <button class="btn btn-outline" onclick="copyResults()" style="margin-top: 1rem;">Copy Results</button>
    </div>

    <footer>
      <p>Jubilee Browser Automated Test Suite v8.0.7 | .NET 8 WPF + WebView2 | &copy; 2025 Jubilee Software, Inc.</p>
    </footer>
  </div>

  <script>
    // InspireCodex API Configuration (Production)
    const INSPIRE_CODEX_API = 'https://inspirecodex.com';

    // Test configuration
    const testSuites = [
      {
        name: 'Environment Detection',
        icon: 'ðŸ”',
        tests: [
          {
            id: 'env-webview2',
            name: 'WebView2 Runtime',
            description: 'Check if running in WebView2 environment',
            run: async () => {
              // Check for WebView2 indicators
              const isWebView2 = navigator.userAgent.includes('Edg/') ||
                                 typeof window.chrome !== 'undefined';
              if (isWebView2) {
                return { passed: true, message: 'WebView2/Edge Chromium detected' };
              }
              return { passed: false, message: 'Not running in WebView2 environment' };
            }
          },
          {
            id: 'env-jubilee-host',
            name: 'Jubilee Host Object',
            description: 'Check if Jubilee WPF host object is available',
            run: async () => {
              // WPF WebView2 exposes host objects via window.chrome.webview.hostObjects
              if (window.chrome?.webview?.hostObjects?.jubilee) {
                return { passed: true, message: 'Jubilee host object available' };
              }
              return { passed: false, message: 'Jubilee host object not found - not running in Jubilee Browser' };
            }
          }
        ]
      },
      {
        name: 'InspireCodex API Connectivity',
        icon: 'ðŸŒ',
        tests: [
          {
            id: 'api-health',
            name: 'API Health Check',
            description: 'Verify InspireCodex API is reachable',
            run: async () => {
              try {
                const response = await fetch(`${INSPIRE_CODEX_API}/health`, {
                  method: 'GET',
                  headers: { 'Accept': 'application/json' }
                });
                if (response.ok) {
                  const data = await response.json();
                  return { passed: true, message: `API Status: ${data.status || 'ok'}` };
                }
                return { passed: false, message: `HTTP ${response.status}` };
              } catch (e) {
                return { passed: false, message: `Connection failed: ${e.message}` };
              }
            }
          },
          {
            id: 'api-status',
            name: 'API Status Endpoint',
            description: 'Check API version and database status',
            run: async () => {
              try {
                const response = await fetch(`${INSPIRE_CODEX_API}/api/v1/status`, {
                  method: 'GET',
                  headers: { 'Accept': 'application/json' }
                });
                if (response.ok) {
                  const data = await response.json();
                  return { passed: true, message: `API v${data.version || '1.0'}, Codex: ${data.databases?.codex?.tables || 0} tables` };
                }
                return { passed: false, message: `HTTP ${response.status}` };
              } catch (e) {
                return { passed: false, message: `Error: ${e.message}` };
              }
            }
          }
        ]
      },
      {
        name: 'Bible Content API',
        icon: 'ðŸ“–',
        tests: [
          {
            id: 'api-bible-verses',
            name: 'Bible Verses Endpoint',
            description: 'Fetch Bible verses from InspireCodex',
            run: async () => {
              try {
                const response = await fetch(`${INSPIRE_CODEX_API}/api/v1/codex/bible/verses?limit=5`, {
                  method: 'GET',
                  headers: { 'Accept': 'application/json' }
                });
                if (response.ok) {
                  const data = await response.json();
                  const count = Array.isArray(data) ? data.length : (data.verses?.length || 0);
                  return { passed: true, message: `Retrieved ${count} verses` };
                }
                return { passed: false, message: `HTTP ${response.status}` };
              } catch (e) {
                return { passed: false, message: `Error: ${e.message}` };
              }
            }
          },
          {
            id: 'api-personas',
            name: 'Personas Endpoint',
            description: 'Fetch available AI personas',
            run: async () => {
              try {
                const response = await fetch(`${INSPIRE_CODEX_API}/api/v1/codex/personas`, {
                  method: 'GET',
                  headers: { 'Accept': 'application/json' }
                });
                if (response.ok) {
                  const data = await response.json();
                  const count = Array.isArray(data) ? data.length : (data.personas?.length || 0);
                  return { passed: true, message: `${count} personas available` };
                }
                return { passed: false, message: `HTTP ${response.status}` };
              } catch (e) {
                return { passed: false, message: `Error: ${e.message}` };
              }
            }
          }
        ]
      },
      {
        name: 'Inspire Content API',
        icon: 'âœ¨',
        tests: [
          {
            id: 'api-devotionals',
            name: 'Devotionals Endpoint',
            description: 'Fetch devotional content',
            run: async () => {
              try {
                const response = await fetch(`${INSPIRE_CODEX_API}/api/v1/inspire/devotionals?limit=3`, {
                  method: 'GET',
                  headers: { 'Accept': 'application/json' }
                });
                if (response.ok) {
                  const data = await response.json();
                  const count = Array.isArray(data) ? data.length : (data.devotionals?.length || 0);
                  return { passed: true, message: `${count} devotionals available` };
                }
                return { passed: false, message: `HTTP ${response.status}` };
              } catch (e) {
                return { passed: false, message: `Error: ${e.message}` };
              }
            }
          },
          {
            id: 'api-categories',
            name: 'Categories Endpoint',
            description: 'Fetch content categories',
            run: async () => {
              try {
                const response = await fetch(`${INSPIRE_CODEX_API}/api/v1/inspire/categories`, {
                  method: 'GET',
                  headers: { 'Accept': 'application/json' }
                });
                if (response.ok) {
                  const data = await response.json();
                  const count = Array.isArray(data) ? data.length : (data.categories?.length || 0);
                  return { passed: true, message: `${count} categories` };
                }
                return { passed: false, message: `HTTP ${response.status}` };
              } catch (e) {
                return { passed: false, message: `Error: ${e.message}` };
              }
            }
          }
        ]
      },
      {
        name: 'Content Filtering',
        icon: 'ðŸ›¡ï¸',
        tests: [
          {
            id: 'filter-blocklist-loaded',
            name: 'Blocklist Available',
            description: 'Verify content blocklist is loaded',
            run: async () => {
              // Check if Jubilee host provides blocklist
              if (window.chrome?.webview?.hostObjects?.jubilee?.checkBlacklist) {
                return { passed: true, message: 'Blocklist API available via host' };
              }
              // Fallback: check if running in Jubilee context
              return { passed: false, message: 'Blocklist API not available - test in Jubilee Browser', skipped: true };
            }
          },
          {
            id: 'filter-safe-site',
            name: 'Allow Safe Sites',
            description: 'Verify safe sites are allowed (jubileeverse.com)',
            run: async () => {
              if (!window.chrome?.webview?.hostObjects?.jubilee?.checkBlacklist) {
                return { passed: false, message: 'Blocklist API not available', skipped: true };
              }
              try {
                const result = await window.chrome.webview.hostObjects.jubilee.checkBlacklist('https://www.jubileeverse.com');
                if (!result) {
                  return { passed: true, message: 'Site correctly allowed' };
                }
                return { passed: false, message: 'Site incorrectly blocked' };
              } catch (e) {
                return { passed: false, message: `Error: ${e.message}` };
              }
            }
          }
        ]
      },
      {
        name: 'Browser Features',
        icon: 'ðŸ”§',
        tests: [
          {
            id: 'feature-settings',
            name: 'Settings Access',
            description: 'Check if browser settings are accessible',
            run: async () => {
              if (window.chrome?.webview?.hostObjects?.jubilee?.getSettings) {
                try {
                  const settings = await window.chrome.webview.hostObjects.jubilee.getSettings();
                  return { passed: true, message: 'Settings retrieved successfully' };
                } catch (e) {
                  return { passed: false, message: `Error: ${e.message}` };
                }
              }
              return { passed: false, message: 'Settings API not available - test in Jubilee Browser', skipped: true };
            }
          },
          {
            id: 'feature-mode',
            name: 'Browse Mode Detection',
            description: 'Check current browsing mode (WWW/WWBW)',
            run: async () => {
              if (window.chrome?.webview?.hostObjects?.jubilee?.getMode) {
                try {
                  const mode = await window.chrome.webview.hostObjects.jubilee.getMode();
                  return { passed: true, message: `Current mode: ${mode}` };
                } catch (e) {
                  return { passed: false, message: `Error: ${e.message}` };
                }
              }
              return { passed: false, message: 'Mode API not available - test in Jubilee Browser', skipped: true };
            }
          }
        ]
      }
    ];

    // State
    let testResults = [];
    let isRunning = false;
    let startTime = 0;

    // Initialize UI
    function initializeUI() {
      // Detect environment
      detectEnvironment();

      // Render test sections
      const container = document.getElementById('testSections');
      container.innerHTML = testSuites.map(suite => `
        <div class="test-section" id="suite-${suite.name.replace(/\s+/g, '-').toLowerCase()}">
          <h3><span class="icon">${suite.icon}</span> ${suite.name}</h3>
          ${suite.tests.map(test => `
            <div class="test-item" id="test-${test.id}">
              <div class="test-status-icon pending" id="icon-${test.id}">?</div>
              <div class="test-name">${test.name}</div>
              <div class="test-message" id="msg-${test.id}">${test.description}</div>
              <div class="test-time" id="time-${test.id}"></div>
            </div>
          `).join('')}
        </div>
      `).join('');

      updateStats();
    }

    // Detect environment
    async function detectEnvironment() {
      const isWebView2 = navigator.userAgent.includes('Edg/') || typeof window.chrome !== 'undefined';
      const isJubilee = window.chrome?.webview?.hostObjects?.jubilee;

      document.getElementById('envBrowser').textContent = isJubilee ? 'Jubilee Browser (WPF)' : (isWebView2 ? 'WebView2/Edge' : 'Standard Browser');
      document.getElementById('envVersion').textContent = isJubilee ? '8.0.7' : 'N/A';

      // Check InspireCodex API
      try {
        const response = await fetch(`${INSPIRE_CODEX_API}/health`, { method: 'GET' });
        document.getElementById('envApi').textContent = response.ok ? 'Connected' : 'Unavailable';
      } catch (e) {
        document.getElementById('envApi').textContent = 'Offline';
      }

      // Check mode
      if (isJubilee && window.chrome.webview.hostObjects.jubilee.getMode) {
        try {
          const mode = await window.chrome.webview.hostObjects.jubilee.getMode();
          document.getElementById('envMode').textContent = mode === 'jubileebibles' ? 'WWBW' : 'WWW';
        } catch (e) {
          document.getElementById('envMode').textContent = 'Unknown';
        }
      } else {
        document.getElementById('envMode').textContent = 'N/A';
      }
    }

    // Log entry
    function log(message, type = 'info') {
      const logContainer = document.getElementById('logEntries');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Update test item UI
    function updateTestUI(testId, status, message, time) {
      const item = document.getElementById(`test-${testId}`);
      const icon = document.getElementById(`icon-${testId}`);
      const msg = document.getElementById(`msg-${testId}`);
      const timeEl = document.getElementById(`time-${testId}`);

      item.className = `test-item ${status}`;
      icon.className = `test-status-icon ${status}`;

      const icons = { pending: '?', running: 'âŸ³', passed: 'âœ“', failed: 'âœ—', skipped: 'âŠ˜' };
      icon.textContent = icons[status] || '?';

      if (message) msg.textContent = message;
      if (time !== undefined) timeEl.textContent = `${time}ms`;
    }

    // Update stats
    function updateStats() {
      const passed = testResults.filter(r => r.passed && !r.skipped).length;
      const failed = testResults.filter(r => !r.passed && !r.skipped).length;
      const skipped = testResults.filter(r => r.skipped).length;
      const total = testSuites.reduce((sum, s) => sum + s.tests.length, 0);
      const completed = testResults.length;
      const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

      document.getElementById('passedCount').textContent = passed;
      document.getElementById('failedCount').textContent = failed;
      document.getElementById('skippedCount').textContent = skipped;
      document.getElementById('totalTime').textContent = `${Date.now() - startTime}ms`;

      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = `${percent}%`;
      progressBar.textContent = `${percent}%`;

      if (failed > 0) {
        progressBar.className = 'progress-bar failed';
      } else if (isRunning) {
        progressBar.className = 'progress-bar running';
      } else {
        progressBar.className = 'progress-bar';
      }
    }

    // Run all tests
    async function runAllTests() {
      if (isRunning) return;

      isRunning = true;
      testResults = [];
      startTime = Date.now();

      document.getElementById('runAllBtn').disabled = true;
      document.getElementById('runAllBtn').innerHTML = '<span class="spinner"></span> Running...';
      document.getElementById('progressTitle').textContent = 'Running tests...';
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('logEntries').innerHTML = '';

      log('Starting automated test suite (WPF + InspireCodex API)...', 'info');

      for (const suite of testSuites) {
        log(`Running suite: ${suite.name}`, 'info');

        for (const test of suite.tests) {
          updateTestUI(test.id, 'running', 'Running...', undefined);

          const testStart = Date.now();
          try {
            const result = await test.run();
            const elapsed = Date.now() - testStart;

            testResults.push({
              id: test.id,
              name: test.name,
              suite: suite.name,
              passed: result.passed,
              skipped: result.skipped || false,
              message: result.message,
              time: elapsed
            });

            const status = result.skipped ? 'skipped' : (result.passed ? 'passed' : 'failed');
            updateTestUI(test.id, status, result.message, elapsed);
            log(`${status.toUpperCase()}: ${test.name} - ${result.message}`, result.passed ? 'success' : (result.skipped ? 'warn' : 'error'));
          } catch (e) {
            const elapsed = Date.now() - testStart;
            testResults.push({
              id: test.id,
              name: test.name,
              suite: suite.name,
              passed: false,
              skipped: false,
              message: `Exception: ${e.message}`,
              time: elapsed
            });
            updateTestUI(test.id, 'failed', `Exception: ${e.message}`, elapsed);
            log(`ERROR: ${test.name} - ${e.message}`, 'error');
          }

          updateStats();
          await new Promise(r => setTimeout(r, 50)); // Small delay for UI updates
        }
      }

      const totalTime = Date.now() - startTime;
      isRunning = false;

      document.getElementById('runAllBtn').disabled = false;
      document.getElementById('runAllBtn').innerHTML = 'Run All Tests';
      document.getElementById('progressTitle').textContent = 'Tests completed';
      document.getElementById('totalTime').textContent = `${totalTime}ms`;

      log(`Test suite completed in ${totalTime}ms`, 'info');
      showResults();
    }

    // Show results
    function showResults() {
      const passed = testResults.filter(r => r.passed && !r.skipped).length;
      const failed = testResults.filter(r => !r.passed && !r.skipped).length;
      const skipped = testResults.filter(r => r.skipped).length;
      const total = testResults.length;
      const percent = Math.round((passed / (total - skipped)) * 100) || 0;

      const summary = document.getElementById('resultsSummary');
      if (failed === 0 && skipped === 0) {
        summary.className = 'results-summary success';
        summary.innerHTML = `âœ“ All ${passed} tests passed!`;
      } else if (failed === 0) {
        summary.className = 'results-summary success';
        summary.innerHTML = `âœ“ ${passed} passed, ${skipped} skipped`;
      } else {
        summary.className = 'results-summary failure';
        summary.innerHTML = `âœ— ${passed} passed, ${failed} failed, ${skipped} skipped`;
      }

      // Generate text report
      let report = `Jubilee Browser v8.0.7 - Automated Test Results\n`;
      report += `Platform: .NET 8 WPF + WebView2\n`;
      report += `API: InspireCodex.com (Production)\n`;
      report += `Date: ${new Date().toLocaleString()}\n`;
      report += `${'='.repeat(60)}\n\n`;

      for (const suite of testSuites) {
        report += `${suite.icon} ${suite.name}\n`;
        report += `${'-'.repeat(40)}\n`;
        const suiteResults = testResults.filter(r => r.suite === suite.name);
        for (const r of suiteResults) {
          const status = r.skipped ? 'SKIP' : (r.passed ? 'PASS' : 'FAIL');
          report += `  [${status}] ${r.name} (${r.time}ms)\n`;
          report += `         ${r.message}\n`;
        }
        report += '\n';
      }

      report += `${'='.repeat(60)}\n`;
      report += `SUMMARY: ${passed} passed, ${failed} failed, ${skipped} skipped\n`;
      report += `Total time: ${Date.now() - startTime}ms\n`;

      document.getElementById('resultsText').textContent = report;
      document.getElementById('resultsSection').classList.remove('hidden');
    }

    // Reset tests
    function resetTests() {
      if (isRunning) return;

      testResults = [];
      document.getElementById('logEntries').innerHTML = '';
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('progressTitle').textContent = 'Ready to run tests';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressBar').textContent = '0%';
      document.getElementById('progressBar').className = 'progress-bar';

      for (const suite of testSuites) {
        for (const test of suite.tests) {
          updateTestUI(test.id, 'pending', test.description, undefined);
          document.getElementById(`time-${test.id}`).textContent = '';
        }
      }

      updateStats();
      log('Tests reset', 'info');
    }

    // Copy results
    function copyResults() {
      const text = document.getElementById('resultsText').textContent;
      navigator.clipboard.writeText(text).then(() => {
        alert('Results copied to clipboard!');
      });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initializeUI);
  </script>
</body>
</html>
